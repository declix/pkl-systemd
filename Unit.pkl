abstract module declix.systemd.Unit;

abstract class Section {
    function render(): String = new Listing {
        for (k, v in this.toMap()) {
            when (v != null) {
                "\(k.capitalize())=\(v)"
            }
        }
        ""
    }.join("\n")
}

// https://www.freedesktop.org/software/systemd/man/latest/systemd.unit.html
class UnitSection extends Section {
    after: String?
    allowIsolate: String?
    before: String?
    bindsTo: String?
    collectMode: String?
    conflicts: String?
    defaultDependencies: String?
    description: String?
    documentation: String?
    failureAction: String?
    failureActionExitStatus: String?
    ignoreOnIsolate: String?
    jobRunningTimeoutSec: String?
    jobTimeoutAction: String?
    jobTimeoutRebootArgument: String?
    jobTimeoutSec: String?
    joinsNamespaceOf: String?
    onFailure: String?
    onFailureJobMode: String?
    onSuccess: String?
    onSuccessJobMode: String?
    partOf: String?
    propagatesReloadTo: String?
    propagatesStopTo: String?
    rebootArgument: String?
    refuseManualStart: String?
    refuseManualStop: String?
    reloadPropagatedFrom: String?
    requires: String?
    requiresMountsFor: String?
    requisite: String?
    sourcePath: String?
    startLimitAction: String?
    startLimitBurst: String?
    startLimitIntervalSec: String?
    stopPropagatedFrom: String?
    stopWhenUnneeded: String?
    successAction: String?
    successActionExitStatus: String?
    surviveFinalKillSignal: String?
    upholds: String?
    wants: String?
    wantsMountsFor: String?
}

// https://www.freedesktop.org/software/systemd/man/latest/systemd.unit.html
class InstallSection extends Section {
    alias: String?
    also: String?
    defaultInstance: String?
    requiredBy: String?
    upheldBy: String?
    wantedBy: String?
}

class UnitFileRenderer extends ValueRenderer {
    function renderDocument(value: Any): String = renderSections(value.toMap())

    function renderSections(map: Map): String = new Listing {
        for (name in map.keys) {
            renderSection(name, map[name])
        }
    }.join("\n")

    function renderSection(name: String, section: Section): String = 
        "[\(name.capitalize())]\n" + section.render()
}

output {
    renderer = new UnitFileRenderer { }
}